
  <!DOCTYPE html>
  <html>
    <head>
      <title>S3ClientUtils.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/common/S3ClientUtils.ts</td><td class="">85.97%</td><td class="">0%</td><td class="">221</td><td class="">190</td><td class="">31</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
	Credentials,
	ICredentials,
	Logger,
	getAmplifyUserAgent,
} from &#x27;@aws-amplify/core&#x27;;
import { StorageAccessLevel, CustomPrefix } from &#x27;../types&#x27;;
import {
	InitializeMiddleware,
	InitializeHandlerOptions,
	FinalizeRequestHandlerOptions,
	FinalizeRequestMiddleware,
	HandlerExecutionContext,
} from &#x27;@aws-sdk/types&#x27;;
import { S3ClientConfig, S3Client } from &#x27;@aws-sdk/client-s3&#x27;;
import { CancelTokenSource } from &#x27;axios&#x27;;
import * as events from &#x27;events&#x27;;
import { AxiosHttpHandler } from &#x27;../providers/axios-http-handler&#x27;;
import {
	localTestingStorageEndpoint,
	SET_CONTENT_LENGTH_HEADER,
} from &#x27;./StorageConstants&#x27;;

const logger = new Logger(&#x27;S3ClientUtils&#x27;);
// placeholder credentials in order to satisfy type requirement, always results in 403 when used
const INVALID_CRED = { accessKeyId: &#x27;&#x27;, secretAccessKey: &#x27;&#x27; };

export const getPrefix = (config: {
	credentials: ICredentials;
	level?: StorageAccessLevel;
	customPrefix?: CustomPrefix;
	identityId?: string;
}): string =&gt; {
	const { credentials, level, customPrefix, identityId } = config;

	const resolvedCustomPrefix = customPrefix || {};
	const resolvedIdentityId = identityId || credentials.identityId;
	const privatePath =
		(resolvedCustomPrefix.private !== undefined
			? resolvedCustomPrefix.private
			: &#x27;private/&#x27;) +
		resolvedIdentityId +
		&#x27;/&#x27;;
	const protectedPath =
		(resolvedCustomPrefix.protected !== undefined
			? resolvedCustomPrefix.protected
			: &#x27;protected/&#x27;) +
		resolvedIdentityId +
		&#x27;/&#x27;;
	const publicPath =
		resolvedCustomPrefix.public !== undefined
			? resolvedCustomPrefix.public
			: &#x27;public/&#x27;;

	switch (level) {
		case &#x27;private&#x27;:
			return privatePath;
		case &#x27;protected&#x27;:
			return protectedPath;
		default:
			return publicPath;
	}
};

export const createPrefixMiddleware = (
	opt: Record&lt;string, any&gt;,
	key: string
): InitializeMiddleware&lt;any, any&gt; =&gt; (next, _context) =&gt; async args =&gt; {
	const credentials = await Credentials.get();
	const cred = Credentials.shear(credentials);
	const prefix = getPrefix({ ...opt, credentials: cred });
	const clonedInput = Object.assign({}, args.input);
	if (Object.prototype.hasOwnProperty.call(args.input, &#x27;Key&#x27;)) {
		clonedInput.Key = prefix + key;
		args.input = clonedInput;
	} else if (Object.prototype.hasOwnProperty.call(args.input, &#x27;Prefix&#x27;)) {
		clonedInput.Prefix = prefix + key;
		args.input = clonedInput;
	}
	const result = next(args);
	return result;
};

const isTimeSkewedError = (err: any): boolean =&gt;
	err.ServerTime &amp;&amp;
	typeof err.Code === &#x27;string&#x27; &amp;&amp;
	err.Code === &#x27;RequestTimeTooSkewed&#x27;;

// we want to take the S3Client config in parameter so we can modify it&#x27;s systemClockOffset
export const autoAdjustClockskewMiddleware = (
	config: S3ClientConfig
): FinalizeRequestMiddleware&lt;any, any&gt; =&gt; (
	next,
	_context: HandlerExecutionContext
) =&gt; async args =&gt; {
	try {
		return await next(args);
	} catch (err) {
		if (isTimeSkewedError(err)) {
			const serverDate = new Date(err.ServerTime);
			config.systemClockOffset = serverDate.getTime() - Date.now();
		}
		throw err;
	}
};

export const autoAdjustClockskewMiddlewareOptions: FinalizeRequestHandlerOptions = {
	step: &#x27;finalizeRequest&#x27;,
	name: &#x27;autoAdjustClockskewMiddleware&#x27;,
};

export const prefixMiddlewareOptions: InitializeHandlerOptions = {
	step: &#x27;initialize&#x27;,
	name: &#x27;addPrefixMiddleware&#x27;,
};

export const credentialsProvider = async () =&gt; {
	try {
		const credentials = await Credentials.get();
		if (!credentials) return INVALID_CRED;
		const cred = Credentials.shear(credentials);
		logger.debug(&#x27;credentials provider get credentials&#x27;, cred);
		return cred;
	} catch (error) {
		logger.warn(&#x27;credentials provider error&#x27;, error);
		return INVALID_CRED;
	}
};

export const createS3Client = (
	config: {
		region?: string;
		cancelTokenSource?: CancelTokenSource;
		dangerouslyConnectToHttpEndpointForTesting?: boolean;
		useAccelerateEndpoint?: boolean;
	},
	emitter?: events.EventEmitter
): S3Client =&gt; {
	const {
		region,
		cancelTokenSource,
		dangerouslyConnectToHttpEndpointForTesting,
		useAccelerateEndpoint,
	} = config;
	let localTestingConfig = {};

	if (dangerouslyConnectToHttpEndpointForTesting) {
		localTestingConfig = {
			endpoint: localTestingStorageEndpoint,
			tls: false,
			bucketEndpoint: false,
			forcePathStyle: true,
		};
	}

	const s3client = new S3Client({
		region,
		// Using provider instead of a static credentials, so that if an upload task was in progress, but credentials gets
		// changed or invalidated (e.g user signed out), the subsequent requests will fail.
		credentials: credentialsProvider,
		customUserAgent: getAmplifyUserAgent(),
		...localTestingConfig,
		requestHandler: new AxiosHttpHandler({}, emitter, cancelTokenSource),
		useAccelerateEndpoint,
	});
	s3client.middlewareStack.remove(SET_CONTENT_LENGTH_HEADER);
	return s3client;
};
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:68,&quot;character&quot;:7,&quot;text&quot;:&quot;credentials&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:69,&quot;character&quot;:32,&quot;text&quot;:&quot;credentials&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:71,&quot;character&quot;:7,&quot;text&quot;:&quot;clonedInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:71,&quot;character&quot;:44,&quot;text&quot;:&quot;input&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:72,&quot;character&quot;:47,&quot;text&quot;:&quot;input&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:73,&quot;character&quot;:2,&quot;text&quot;:&quot;clonedInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:73,&quot;character&quot;:14,&quot;text&quot;:&quot;Key&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:74,&quot;character&quot;:7,&quot;text&quot;:&quot;input&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:74,&quot;character&quot;:15,&quot;text&quot;:&quot;clonedInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:75,&quot;character&quot;:54,&quot;text&quot;:&quot;input&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:2,&quot;text&quot;:&quot;clonedInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:14,&quot;text&quot;:&quot;Prefix&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:77,&quot;character&quot;:7,&quot;text&quot;:&quot;input&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:77,&quot;character&quot;:15,&quot;text&quot;:&quot;clonedInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:83,&quot;character&quot;:27,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:84,&quot;character&quot;:1,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:84,&quot;character&quot;:5,&quot;text&quot;:&quot;ServerTime&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:85,&quot;character&quot;:8,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:85,&quot;character&quot;:12,&quot;text&quot;:&quot;Code&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:86,&quot;character&quot;:1,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:86,&quot;character&quot;:5,&quot;text&quot;:&quot;Code&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:98,&quot;character&quot;:24,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:99,&quot;character&quot;:31,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:99,&quot;character&quot;:35,&quot;text&quot;:&quot;ServerTime&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:8,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:97,&quot;character&quot;:10,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:118,&quot;character&quot;:8,&quot;text&quot;:&quot;credentials&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:119,&quot;character&quot;:7,&quot;text&quot;:&quot;credentials&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:120,&quot;character&quot;:33,&quot;text&quot;:&quot;credentials&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:124,&quot;character&quot;:44,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/common/S3ClientUtils.ts&quot;,&quot;line&quot;:123,&quot;character&quot;:10,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Mon, 17 Oct 2022 20:15:23 GMT</p>
    </body>
  </html>
  